// 24HRMVP Database Schema
// PostgreSQL 16.10+ with Prisma ORM 5.x

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String              @id @default(cuid())
  fid             Int                 @unique
  username        String
  displayName     String?
  pfpUrl          String?
  custodyAddress  String?
  verifications   String[]
  membershipTier  String              @default("free")
  points          Int                 @default(0)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relations
  ideas           Idea[]
  votes           Vote[]
  notifications   NotificationToken[]
  achievements    Achievement[]

  @@index([fid])
  @@index([username])
  @@index([points])
}

model Idea {
  id              String       @id @default(cuid())
  title           String
  description     String
  category        String
  complexity      String
  attachments     String[]
  status          String       @default("pending")
  voteCount       Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  // Relations
  submittedBy     User         @relation(fields: [userId], references: [id])
  userId          String
  votingCycle     VotingCycle  @relation(fields: [votingCycleId], references: [id])
  votingCycleId   String
  votes           Vote[]
  mvpProject      MVPProject?

  @@index([votingCycleId])
  @@index([userId])
  @@index([status])
  @@index([voteCount])
  @@index([category])
  @@index([createdAt])
}

model VotingCycle {
  id         String   @id @default(cuid())
  startDate  DateTime
  endDate    DateTime
  status     String   @default("active")
  winnerId   String?
  createdAt  DateTime @default(now())
  
  // Relations
  ideas      Idea[]

  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

model Vote {
  id        String   @id @default(cuid())
  weight    Int      @default(1)
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  idea      Idea     @relation(fields: [ideaId], references: [id])
  ideaId    String

  @@unique([userId, ideaId])
  @@index([userId])
  @@index([ideaId])
  @@index([createdAt])
}

model MVPProject {
  id            String    @id @default(cuid())
  repoUrl       String?
  deploymentUrl String?
  status        String    @default("queued")
  progress      Int       @default(0)
  logs          Json[]
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  idea          Idea      @relation(fields: [ideaId], references: [id])
  ideaId        String    @unique

  @@index([status])
  @@index([createdAt])
}

model NotificationToken {
  id              String   @id @default(cuid())
  token           String   @unique
  notificationUrl String
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  
  // Relations
  user            User     @relation(fields: [userId], references: [id])
  userId          String

  @@index([userId])
  @@index([enabled])
}

model Achievement {
  id          String   @id @default(cuid())
  type        String
  name        String
  description String
  earnedAt    DateTime @default(now())
  
  // Relations
  user        User     @relation(fields: [userId], references: [id])
  userId      String

  @@index([userId])
  @@index([type])
  @@index([earnedAt])
}

model Payment {
  id          String   @id @default(cuid())
  paymentId   String   @unique
  method      String   // 'stripe' or 'coinbase'
  amount      Float
  tier        String   // 'standard', 'priority', 'premium'
  status      String   @default("pending")
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([paymentId])
}
